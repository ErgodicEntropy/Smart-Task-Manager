{% extends 'base.html' %}

{% block head %}
    <style>
        .completed {
            text-decoration: line-through;
            background-color: #e0ffe0;
            color: green;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .finish-button {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .finish-button:hover {
            background-color: #45a049;
        }

        .task-row {
            transition: background-color 0.3s ease;
        }

        .task-row.finished {
            background-color: #e0ffe0;
        }

        .recommendation {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
    
        .recommendation:hover {
            background-color: #007B9E;
        }

        .explain {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
    
        .explain:hover {
            background-color: #007B9E;
        }

    </style>
{% endblock %}

{% block body %}
<div class="content">
    <h1 style="text-align:center">Optimal Task List</h1>
    <p style="text-align:center">Here is your task list aligned with your energy level!</p>
    
    <table>
        <thead>
            <tr>
                <th>Task</th>
                <th>Energy Requirement</th>
                <th>AI Assistance</th>
                <th>Rank Explanation</th>
                <th>Doing State</th>
                <th>Done State</th>
            </tr>
        </thead>
        <tbody>
            {% for task in optimal_task_list %}
            <tr class="task-row" id="task-{{ loop.index }}">
                <td class="{% if task.finished %}completed{% endif %}">{{ task.content }}</td>
                <td>{{ task.energy_required }}</td>

                <td>
                    <a href="/recommendation/{{ task.id }}"  class="recommendation">Recommendation</a><br>
                </td>    

                <td>
                    <a href="/explanation/{{ task.id }}"  class="explain">Explain Rank</a><br>
                </td>    

                <!-- Kanban Board -->
                <td>
                    <a href="#" class="doing-button" onclick="markAsDoing('{{ loop.index }}')">Doing</a><br>
                </td>    
                <td>
                    <a href="#" class="finish-button" onclick="markAsFinished('{{ loop.index }}')">Finished</a><br>
                </td>    
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<!-- Kanban Board: implement a timer for the doing board unless the user feedbacks the time required for that task himself -->
<!-- User Feedback on Finished Tasks -->

<script>
    let timers = {};

    function startTimer(taskId) {
        const startTime = Date.now();
        timers[taskId] = startTime;

        const timerDisplay = document.createElement('span');
        timerDisplay.id = 'timer-' + taskId;
        timerDisplay.style.marginLeft = '10px';
        document.getElementById('task-' + taskId).appendChild(timerDisplay);

        updateTimer(taskId);
    }

    function updateTimer(taskId) {
        const timerDisplay = document.getElementById('timer-' + taskId);
        if (!timerDisplay) return;

        const elapsedTime = Date.now() - timers[taskId];
        const seconds = Math.floor((elapsedTime / 1000) % 60);
        const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
        const hours = Math.floor((elapsedTime / (1000 * 60 * 60)) % 24);

        timerDisplay.innerHTML = `${hours}h ${minutes}m ${seconds}s`;

        setTimeout(() => updateTimer(taskId), 1000);
    }

    function stopTimer(taskId) {
        delete timers[taskId];
        const timerDisplay = document.getElementById('timer-' + taskId);
        if (timerDisplay) {
            timerDisplay.remove();
        }
    }

    function markAsDoing(taskId) {
        const taskRow = document.getElementById('task-' + taskId);
        const taskContent = taskRow.querySelector('td');

        taskRow.classList.add('doing');
        taskContent.classList.add('almost_completed');

        const doingButton = taskRow.querySelector('.doing-button');
        doingButton.innerHTML = 'Doing';
        doingButton.style.backgroundColor = '#808080';
        doingButton.style.cursor = 'not-allowed';

        startTimer(taskId);
    }
    
    function getFeedback(taskId) {
        const feedback = prompt("Please provide feedback for the task (easy, moderate, hard):");
        if (feedback) {
            saveFeedback(taskId, feedback);
        }
    }
    
    function saveFeedback(taskId, feedback) {
        fetch('/save_feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ taskId: taskId, feedback: feedback }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Feedback saved:', data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
    
    function markAsFinished(taskId) {
        const taskRow = document.getElementById('task-' + taskId);
        const taskContent = taskRow.querySelector('td');

        taskRow.classList.add('finished');
        taskContent.classList.add('completed');
        
        const finishButton = taskRow.querySelector('.finish-button');
        finishButton.innerHTML = 'Completed';
        finishButton.style.backgroundColor = '#808080';
        finishButton.style.cursor = 'not-allowed';

        stopTimer(taskId);
        getFeedback(taskId);
    }
    
</script>

<style>
    .doing {
        background-color: #fff3cd;
        border-left: 5px solid #ffc107;
        transition: background-color 0.3s ease, border-left 0.3s ease;
        font-weight: bold;
    }

    .finished {
        background-color: #d4edda;
        border-left: 5px solid #28a745;
        transition: background-color 0.3s ease, border-left 0.3s ease;
        text-decoration: line-through;
        color: red;
        font-weight: bold;
    }

</style>

{% endblock %}
